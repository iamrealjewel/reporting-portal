name: Deploy to cPanel

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install Frontend Dependencies & Build
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Install Backend Dependencies & Build
        run: |
          cd backend
          npm ci
          npx prisma generate
          npx tsc

      - name: Prepare deployment
        run: |
          mkdir -p deploy/frontend
          mkdir -p deploy/backend
          
          # Copy frontend production build and modules
          cp -r frontend/dist/. deploy/frontend/
          cp -r frontend/node_modules deploy/frontend/
          
          # Copy backend compiled files, package files, prisma schema, and modules
          cp -r backend/dist/. deploy/backend/
          cp backend/package.json deploy/backend/
          cp backend/package-lock.json deploy/backend/
          cp -r backend/prisma deploy/backend/
          cp -r backend/node_modules deploy/backend/
          
          # Create app.js entry point for cPanel Passenger
          echo "require('./backend/index.js');" > deploy/app.js
          
          # Create tmp folder and restart.txt for cPanel
          mkdir -p deploy/tmp
          touch deploy/tmp/restart.txt
          
          # Create a single ZIP file for the entire deployment to handle node_modules efficiently
          cd deploy && zip -r ../deploy.zip . && cd ..

      - name: Deploy to cPanel via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./
          server-dir: ${{ secrets.FTP_SERVER_DIR }}/
          dangerous-clean-slate: false
          exclude: |
            **
            !deploy.zip
